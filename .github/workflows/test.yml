name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build test image
      run: |
        docker compose -f docker-compose.dev.yml --profile test build test
    
    - name: Run unit tests with coverage
      env:
        SECRET_KEY: test-secret-key-for-ci
        DJANGO_DEBUG: 'False'
      run: |
        docker compose -f docker-compose.dev.yml --profile test run --rm test pytest --cov=api --cov=frontend --cov-report=xml --cov-report=term-missing -v -m "not integration"
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./src/coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Generate test secret key
      id: secret-key
      run: |
        echo "SECRET_KEY=$(python3 -c 'import secrets; print(secrets.token_urlsafe(50))')" >> $GITHUB_ENV
    
    - name: Generate test license key
      id: license-key
      run: |
        echo "COMPLEASY_LICENSE_KEY=test-license-key-$(date +%s)" >> $GITHUB_ENV
    
    - name: Build Docker images
      run: |
        docker compose -f docker-compose.dev.yml build
    
    - name: Start Compleasy service
      run: |
        docker compose -f docker-compose.dev.yml up -d compleasy
      env:
        SECRET_KEY: ${{ env.SECRET_KEY }}
    
    - name: Wait for service to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8000/health/; do sleep 2; done' || (echo "Service failed to start. Showing logs:" && docker compose -f docker-compose.dev.yml logs compleasy && exit 1)
    
    - name: Create test license key in database
      run: |
        docker compose -f docker-compose.dev.yml exec -T compleasy python manage.py shell <<EOF
        from django.contrib.auth.models import User
        from api.models import LicenseKey, Organization
        user = User.objects.first()
        org, _ = Organization.objects.get_or_create(
            slug='default',
            defaults={'name': 'Default Organization', 'is_active': True}
        )
        if not LicenseKey.objects.filter(licensekey='${{ env.COMPLEASY_LICENSE_KEY }}').exists():
            LicenseKey.objects.create(
                licensekey='${{ env.COMPLEASY_LICENSE_KEY }}',
                name='Integration Test License',
                created_by=user,
                organization=org,
                max_devices=None,
                is_active=True
            )
        EOF
    
    - name: Run Lynis integration test
      run: |
        docker compose -f docker-compose.dev.yml up --abort-on-container-exit lynis-client
      env:
        COMPLEASY_LICENSE_KEY: ${{ env.COMPLEASY_LICENSE_KEY }}
    
    - name: Check integration test results
      run: |
        # Inspect by container name to avoid empty ID when the container has exited
        if ! docker inspect lynis-client >/dev/null 2>&1; then
          echo "lynis-client container not found. Dumping compose ps and logs for debugging."
          docker compose -f docker-compose.dev.yml ps -a || true
          docker compose -f docker-compose.dev.yml logs lynis-client || true
          exit 1
        fi
        EXIT_CODE=$(docker inspect -f '{{.State.ExitCode}}' lynis-client)
        if [ "$EXIT_CODE" != "0" ]; then
          echo "Integration test failed with exit code $EXIT_CODE"
          docker compose -f docker-compose.dev.yml logs lynis-client
          exit 1
        fi
    
    - name: Cleanup
      if: always()
      run: |
        docker compose -f docker-compose.dev.yml down -v

