name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build test image
      run: |
        docker compose -f docker-compose.dev.yml --profile test build test
    
    - name: Run unit tests with coverage
      env:
        SECRET_KEY: test-secret-key-for-ci
        DJANGO_DEBUG: 'False'
      run: |
        docker compose -f docker-compose.dev.yml --profile test run --rm test pytest --cov=api --cov=frontend --cov-report=xml --cov-report=term-missing -v -m "not integration"
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./src/coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Generate test secret key
      id: secret-key
      run: |
        echo "SECRET_KEY=$(python3 -c 'import secrets; print(secrets.token_urlsafe(50))')" >> $GITHUB_ENV
    
    - name: Generate test license key
      id: license-key
      run: |
        echo "COMPLEASY_LICENSE_KEY=test-license-key-$(date +%s)" >> $GITHUB_ENV
    
    - name: Build Docker images
      run: |
        docker compose -f docker-compose.dev.yml build
    
    - name: Start Compleasy service
      run: |
        docker compose -f docker-compose.dev.yml up -d compleasy-dev
      env:
        SECRET_KEY: ${{ env.SECRET_KEY }}
    
    - name: Wait for service to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8000/api/; do sleep 2; done'
    
    - name: Create test license key in database
      run: |
        docker compose -f docker-compose.dev.yml exec -T compleasy-dev python manage.py shell <<EOF
        from django.contrib.auth.models import User
        from api.models import LicenseKey
        user = User.objects.first()
        if not LicenseKey.objects.filter(licensekey='${{ env.COMPLEASY_LICENSE_KEY }}').exists():
            LicenseKey.objects.create(licensekey='${{ env.COMPLEASY_LICENSE_KEY }}', created_by=user)
        EOF
    
    - name: Run Lynis integration test
      run: |
        docker compose -f docker-compose.dev.yml up --abort-on-container-exit lynis-client
      env:
        COMPLEASY_LICENSE_KEY: ${{ env.COMPLEASY_LICENSE_KEY }}
    
    - name: Check integration test results
      run: |
        EXIT_CODE=$(docker compose -f docker-compose.dev.yml ps -q lynis-client | xargs docker inspect -f '{{.State.ExitCode}}')
        if [ "$EXIT_CODE" != "0" ]; then
          echo "Integration test failed with exit code $EXIT_CODE"
          docker compose -f docker-compose.dev.yml logs lynis-client
          exit 1
        fi
    
    - name: Cleanup
      if: always()
      run: |
        docker compose -f docker-compose.dev.yml down -v

