# Compleasy

> [!WARNING]
> This project is still in development and should NOT be used in production.

**Compleasy** is a Linux server auditing solution based on [Lynis](https://cisofy.com/lynis/). It is designed to simplify and automate the process of ensuring your servers adhere to security and operational policies.

## Features

- **Easy implementation:** Compleasy server is a Docker-based solution that can be deployed in minutes.
- **Easy configuration:** Compleasy client is based on Lynis, which can be installed on any Linux server in seconds.
- **Centralized management:** All audit results are sent to the Compleasy server, where they can be viewed and managed.
- **Customizable policies:** Compleasy allows you to define custom policies that can be applied to all servers.

## Installation vÃ­a Docker

### Prerequisites

Before starting, you need to set up the required environment variables:

1. Copy the example environment file:

```bash
cp .env.example .env
```

2. Generate a secure SECRET_KEY:

```bash
python3 -c "import secrets; print(secrets.token_urlsafe(50))"
```

3. Edit the `.env` file and replace `GENERATE_THIS_SECRET_KEY_AS_EXPLAINED_ABOVE` with your newly generated key.

4. (Optional) For development environments only, you can enable DEBUG mode by adding `DJANGO_DEBUG=True` to your `.env` file. 

> [!CAUTION]
> **Security Critical:** NEVER set `DJANGO_DEBUG=True` in production environments. Running with DEBUG enabled exposes sensitive information including stack traces, environment variables, and database queries to potential attackers. The default is `False` for security.

### Setup

1. Clone the repository:

```bash
git clone https://github.com/compleasy/compleasy.git
```

2. Change to the project directory:

```bash
cd compleasy
```

> [!IMPORTANT]
> **Security Note:** The `SECRET_KEY` is a critical security setting for Django. Never commit your actual secret key to version control. The `.env` file is excluded from git to protect your secrets. For production deployments, always generate a new unique SECRET_KEY.

3. Run docker compose:

```bash
docker compose up
```

## Client configuration

1. Install Lynis:

```bash
sudo apt install lynis
```

2. Generate a Lynis custom profile `/etc/lynis/custom.prf`:

```ini
# Custom profile for Compleasy
upload=yes
# License key will be generated by the server on the first run
license-key=YOUR_LICENSE_KEY
# Point to the Compleasy server
upload-server=yourserver:3000/api/lynis
# Required for self-signed certificates
upload-options=--insecure

# Custom settings
# Too slow. Old systems do not support ignoring some directories
test_skip_always=CRYP-7902
```

3. Run Lynis with the custom profile and upload the results to the Compleasy server:

```bash
lynis audit system --upload --quick
```

> [!NOTE]
> You can use `lynis only-upload` to upload the last audit results.

4. Schedule the audit with a cron job (available in recent Debian/Ubuntu versions):

```bash
systemctl start lynis.timer
```

5. (Recommended) Install the following packages to get the most out of Lynis:

```bash
sudo apt install rkhunter auditd aide
```


## Using Compleasy

1. Access the Compleasy server at `http://yourserver:3000`.


### Advanced configuration

- **Add a license key**: `curl -k https://yourserver:3000/admin/license -X POST -d "licensekey=YOUR_LICENSE`
- **Empty the database**: `curl https://yourserver:3000/admin/db/init?delete=true -k`

## Development & Testing

### Prerequisites

- Docker and Docker Compose
- No local Python installation required

### Setup Development Environment

No local installation required! All development and testing happens in Docker containers.

The test container automatically runs database migrations before executing tests.

### Running Tests Locally

All tests run inside Docker containers - no local installation required.

#### Unit Tests

Run all unit tests:

```bash
docker compose -f docker compose.dev.yml --profile test run --rm test
```

Run specific test file:

```bash
docker compose -f docker compose.dev.yml --profile test run --rm test pytest api/tests.py -v
```

Run with HTML coverage report:

```bash
docker compose -f docker compose.dev.yml --profile test run --rm test pytest --cov=api --cov=frontend --cov-report=html --cov-report=term-missing
```

Run specific test:

```bash
docker compose -f docker compose.dev.yml --profile test run --rm test pytest api/tests.py::TestUploadReport::test_upload_report_valid_license_new_device -v
```

Run tests excluding integration tests:

```bash
docker compose -f docker compose.dev.yml --profile test run --rm test pytest -m "not integration" -v
```

Access the test container shell for debugging:

```bash
docker compose -f docker compose.dev.yml --profile test run --rm test /bin/bash
```

#### Integration Tests

Integration tests require Docker and test the full Lynis workflow:

1. Start the development environment:

```bash
# Set environment variables
export SECRET_KEY=$(python3 -c 'import secrets; print(secrets.token_urlsafe(50))')
export COMPLEASY_LICENSE_KEY=test-license-key-$(date +%s)

# Start services
docker compose -f docker compose.dev.yml up -d compleasy-dev
```

2. Wait for the service to be ready:

```bash
# Wait for health check
docker compose -f docker compose.dev.yml ps
```

3. Create a test license key in the database:

```bash
docker compose -f docker compose.dev.yml exec compleasy-dev python manage.py shell <<EOF
from django.contrib.auth.models import User
from api.models import LicenseKey
user = User.objects.first()
LicenseKey.objects.create(licensekey='$COMPLEASY_LICENSE_KEY', created_by=user)
EOF
```

4. Run the Lynis integration test:

```bash
docker compose -f docker compose.dev.yml up --abort-on-container-exit lynis-client
```

5. Run Python integration tests:

```bash
docker compose -f docker compose.dev.yml --profile test run --rm test pytest api/tests_integration.py -v -m integration
```

6. Cleanup:

```bash
docker compose -f docker compose.dev.yml down -v
```

### Test Structure

- `src/api/tests.py` - Unit tests for API endpoints (`upload_report`, `check_license`)
- `src/api/tests_integration.py` - Integration tests for end-to-end Lynis workflow
- `src/conftest.py` - Shared pytest fixtures (LicenseKey, Device, mock Lynis reports)
- `pytest.ini` - Pytest configuration
- `docker compose.dev.yml` - Development environment with Compleasy and Lynis client
- `lynis/Dockerfile` - Docker image for Lynis client testing
- `lynis/run-lynis-test.sh` - Script to automate Lynis scan and report upload

### Continuous Integration

Tests run automatically on:
- Push to `main` or `develop` branches
- Pull requests to `main` or `develop` branches

The CI pipeline includes:
- Unit tests with coverage reporting
- Integration tests with Docker
- Code quality checks

See `.github/workflows/test.yml` for the complete CI configuration.