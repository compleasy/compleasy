services:
  trikusec:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trikusec-dev
    volumes:
      - ./src:/app
    environment:
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DJANGO_ENV=development
      - DJANGO_DEBUG=True
      - TRIKUSEC_URL=${TRIKUSEC_URL:-http://trikusec:8000}
      - TRIKUSEC_LYNIS_API_URL=${TRIKUSEC_LYNIS_API_URL:-https://nginx-dev:443}
      - TRIKUSEC_ADMIN_USERNAME=admin
      - TRIKUSEC_ADMIN_PASSWORD=trikusec
      - TRIKUSEC_LICENSE_KEY=${TRIKUSEC_LICENSE_KEY:-aaaaaaaa-bbbbbbbb-cccccccc}
      - DJANGO_ALLOWED_HOSTS=*
    ports:
      - 8000:8000
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  nginx:
    image: nginx:latest
    container_name: nginx-dev
    ports:
      - 8001:443
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/generate-certs.sh:/docker-entrypoint.d/40-generate-cert.sh
      - ./nginx/certs:/etc/nginx/certs
    environment:
      - NGINX_CERT_CN=${NGINX_CERT_CN:-nginx-dev}
    depends_on:
      trikusec:
        condition: service_healthy
    networks:
      - default

  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: trikusec-test
    volumes:
      - ./src:/app
      - ./pytest.ini:/app/pytest.ini
    environment:
      - SECRET_KEY=${SECRET_KEY:-test-secret-key-for-testing}
      - DJANGO_ENV=testing
      - DJANGO_DEBUG=False
      - DJANGO_ALLOWED_HOSTS=*
    working_dir: /app
    command: ["pytest", "-v", "--cov=api", "--cov=frontend", "--cov-report=term-missing"]
    profiles:
      - test

  test-e2e:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: trikusec-test-e2e
    volumes:
      - ./src:/app
      - ./pytest.ini:/app/pytest.ini
    environment:
      - SECRET_KEY=${SECRET_KEY:-test-secret-key-for-testing}
      - DJANGO_ENV=testing
      - DJANGO_DEBUG=False
      - DJANGO_ALLOWED_HOSTS=*
      - DJANGO_ALLOW_ASYNC_UNSAFE=True
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    working_dir: /app
    command: ["pytest", "-v", "-m", "e2e"]
    profiles:
      - test
    depends_on:
      - trikusec

  lynis-client:
    build:
      context: .
      dockerfile: lynis/Dockerfile
    container_name: lynis-client
    environment:
      - TRIKUSEC_SERVER_URL=https://nginx-dev:443
      - TRIKUSEC_LICENSE_KEY=${TRIKUSEC_LICENSE_KEY:-aaaaaaaa-bbbbbbbb-cccccccc}
      - DEBIAN_FRONTEND=noninteractive
    depends_on:
      nginx:
        condition: service_started
    networks:
      - default
    command: ["/test/run-lynis-test.sh"]

networks:
  default:
    name: trikusec-dev-network

