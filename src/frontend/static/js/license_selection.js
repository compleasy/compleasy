// Shared license selection functionality for onboarding and enroll pages

// Function to get the next available number for autogenerated licenses
function getNextAutogeneratedLicenseNumber(autogeneratedLicenseNames) {
    const pattern = /^Autogenerated license-key (\d+)$/;
    let maxNumber = 0;
    
    // Extract numbers from existing autogenerated license names
    autogeneratedLicenseNames.forEach(name => {
        const match = name.match(pattern);
        if (match) {
            const number = parseInt(match[1], 10);
            if (number > maxNumber) {
                maxNumber = number;
            }
        }
    });
    
    // Return the next available number
    return maxNumber + 1;
}

// Initialize license selection functionality
function initLicenseSelection(config) {
    const {
        trikusecUrl,
        defaultLicenseKey,
        autogeneratedLicenseNames,
        updateEnrollCommandCallback,
        selectedLicenseKey,
        selectedLicenseName
    } = config;
    
    // Use selected license key if provided, otherwise use default
    let currentLicenseKey = selectedLicenseKey || defaultLicenseKey;
    let enrollCommand = `wget -qO- --no-check-certificate ${trikusecUrl}/download/enroll.sh?licensekey=${currentLicenseKey} | bash`;
    
    // Function to update the enroll command
    function updateEnrollCommand(licenseKey) {
        currentLicenseKey = licenseKey;
        enrollCommand = `wget -qO- --no-check-certificate ${trikusecUrl}/download/enroll.sh?licensekey=${licenseKey} | bash`;
        const commandElement = document.getElementById('enroll-command');
        if (commandElement) {
            commandElement.textContent = enrollCommand;
        }
        // Call callback if provided
        if (updateEnrollCommandCallback) {
            updateEnrollCommandCallback(enrollCommand);
        }
    }
    
    // Function to set button state
    function setButtonState(button, text, classesToAdd, classesToRemove) {
        button.textContent = text;
        classesToRemove.forEach(cls => button.classList.remove(cls));
        classesToAdd.forEach(cls => button.classList.add(cls));
    }
    
    // Function to copy to clipboard
    function copyToClipboard(button) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(enrollCommand).then(() => {
                setButtonState(button, 'Copied', ['bg-gray-600', 'hover:bg-gray-700'], ['bg-blue-500', 'hover:bg-blue-600']);
                setTimeout(() => {
                    setButtonState(button, 'Copy', ['bg-blue-500', 'hover:bg-blue-600'], ['bg-gray-600', 'hover:bg-gray-700']);
                }, 2000);
            });
            return;
        }
        
        const textarea = document.createElement('textarea');
        textarea.value = enrollCommand;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
    }
    
    // Handle license option change
    function handleLicenseOptionChange() {
        const selectedOption = document.querySelector('input[name="license-option"]:checked');
        if (!selectedOption) return;
        
        const value = selectedOption.value;
        
        if (value === 'selected' && selectedLicenseKey) {
            // Use selected license key
            updateEnrollCommand(selectedLicenseKey);
        } else if (value === 'generate') {
            // Calculate the next available number for autogenerated licenses
            const nextNumber = getNextAutogeneratedLicenseNumber(autogeneratedLicenseNames);
            const licenseName = `Autogenerated license-key ${nextNumber}`;
            
            // Open the license edit panel in create mode
            if (typeof toggleLicenseEditPanel !== 'undefined') {
                toggleLicenseEditPanel(null);
            }
            
            // Ensure form action is correct
            const form = document.getElementById('license-edit-form');
            if (form) {
                form.action = '/licenses/create/';
            }
            
            // Pre-fill the form with autogenerated values
            // Use setTimeout to ensure the panel is visible and fields are accessible
            setTimeout(() => {
                const nameField = document.getElementById('license_name');
                const maxDevicesField = document.getElementById('license_max_devices');
                const isActiveField = document.getElementById('license_is_active');
                const isActiveMessage = document.getElementById('license_is_active_message');
                const expiresAtField = document.getElementById('license_expires_at');
                
                if (nameField) nameField.value = licenseName;
                if (maxDevicesField) maxDevicesField.value = '1';
                if (isActiveField) isActiveField.checked = true;
                if (isActiveMessage) isActiveMessage.textContent = 'ACTIVE';
                if (expiresAtField) expiresAtField.value = '';
            }, 100);
            
        } else {
            // Use default license key
            updateEnrollCommand(defaultLicenseKey);
        }
    }
    
    // Override form submission for license selection pages
    setTimeout(function() {
        const form = document.getElementById('license-edit-form');
        if (form) {
            // Store original submitLicenseForm if it exists
            const originalSubmitLicenseForm = window.submitLicenseForm;
            
            // Override submitLicenseForm
            window.submitLicenseForm = function() {
                const form = document.getElementById('license-edit-form');
                // Ensure form action is correct
                if (form && !form.action.includes('/edit/')) {
                    form.action = '/licenses/create/';
                }
                const formData = new FormData(form);
                
                // Show loading state
                const submitButton = form.querySelector('button[type="submit"]');
                if (!submitButton) return;
                
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Saving...';
                submitButton.disabled = true;
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update the command with the newly created license key
                        if (data.licensekey) {
                            updateEnrollCommand(data.licensekey);
                        }
                        
                        // Close the panel without resetting the radio button
                        // (since save was successful, keep "Generate specific license key" selected)
                        const panel = document.getElementById('license-edit-panel');
                        if (panel) {
                            panel.classList.add('hidden');
                        }
                    } else {
                        // Show errors
                        if (typeof showFormErrors !== 'undefined') {
                            showFormErrors(data.errors);
                        } else {
                            console.error('Form errors:', data.errors);
                        }
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (typeof showFormErrors !== 'undefined') {
                        showFormErrors(['An error occurred while saving the license.']);
                    } else {
                        alert('An error occurred while saving the license.');
                    }
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                });
            };
        }
    }, 100);
    
    // Override toggleLicenseEditPanel to handle Cancel button
    setTimeout(function() {
        if (typeof toggleLicenseEditPanel !== 'undefined') {
            const originalToggleLicenseEditPanel = window.toggleLicenseEditPanel;
            let wasCreating = false; // Track if we were creating a new license
            
            window.toggleLicenseEditPanel = function(licenseId) {
                const panel = document.getElementById('license-edit-panel');
                const wasHidden = panel.classList.contains('hidden');
                
                // Track if this is a create operation (licenseId is null/undefined)
                wasCreating = (licenseId === null || licenseId === undefined);
                
                // Call original function
                originalToggleLicenseEditPanel(licenseId);
                
                // If we're closing the panel (it was visible) and it was a create operation
                // This handles the Cancel button case - reset to default license
                if (!wasHidden && wasCreating) {
                    // Small delay to ensure panel state has updated
                    setTimeout(() => {
                        // Check if "Generate" option is selected
                        const generateOption = document.getElementById('license-option-generate');
                        if (generateOption && generateOption.checked) {
                            // User clicked Cancel, so reset to default license key option
                            const defaultOption = document.getElementById('license-option-default');
                            if (defaultOption) {
                                defaultOption.checked = true;
                                updateEnrollCommand(defaultLicenseKey);
                            }
                        }
                    }, 100);
                }
            };
            
            // Also handle Cancel button clicks directly via event delegation
            // This ensures cancel works even if toggleLicenseEditPanel logic doesn't catch it
            document.addEventListener('click', function(e) {
                const cancelButton = e.target.closest('button.license-edit-panel-button');
                if (cancelButton && cancelButton.textContent.trim() === 'Cancel') {
                    const panel = document.getElementById('license-edit-panel');
                    if (panel && !panel.classList.contains('hidden')) {
                        // Panel is visible and cancel was clicked
                        // Check if form action indicates we're creating (not editing)
                        const form = document.getElementById('license-edit-form');
                        const isCreating = form && form.action.includes('/create/');
                        
                        if (isCreating) {
                            // Small delay to let the panel close first, then reset
                            setTimeout(() => {
                                const generateOption = document.getElementById('license-option-generate');
                                if (generateOption && generateOption.checked) {
                                    // Reset to default license key option
                                    const defaultOption = document.getElementById('license-option-default');
                                    if (defaultOption) {
                                        defaultOption.checked = true;
                                        updateEnrollCommand(defaultLicenseKey);
                                    }
                                }
                            }, 150);
                        }
                    }
                }
            });
        }
    }, 100);
    
    // Set up event listeners
    document.addEventListener('DOMContentLoaded', () => {
        const copyButton = document.getElementById('copy-command-btn');
        if (copyButton) {
            copyButton.addEventListener('click', () => copyToClipboard(copyButton));
        }
        
        // Add event listeners for license option radio buttons
        const licenseOptions = document.querySelectorAll('input[name="license-option"]');
        licenseOptions.forEach(option => {
            option.addEventListener('change', handleLicenseOptionChange);
        });
    });
    
    // Return public API
    return {
        updateEnrollCommand,
        currentLicenseKey: () => currentLicenseKey,
        enrollCommand: () => enrollCommand
    };
}

