{% block head %}
{{ rulesets|json_script:"rulesets-data" }}
{{ rules|json_script:"rules-data" }}
{% endblock %}

<!-- Hidden right panel, for rule management -->
<div id="rule-selection-panel" class="hidden fixed right-0 bottom-0 h-full w-1/4 bg-white shadow-md" data-ruleset-id="">
    <div class="flex justify-between items-center p-4 border-b bg-gray-200">
        <h2 class="text-xl font-bold">Rules</h2>
        <button class="text-gray-600" onclick="toggleRuleSelectionPanel()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
    <!-- under the Rules title: search bar and create button (both in 1-row) -->
    <div class="p-4 bg-gray-200">
        <input type="text" class="w-4/5 border border-gray-300 p-2 rounded-lg" placeholder="Search rules" onKeyUp="searchRuleByName(this.value)" autocomplete="off" />
        <button class="bg-gray-500 text-white px-4 py-2 rounded" onclick="toggleRuleEditPanel(event)">+ Rule</button>
    </div>

    <div class="p-4">
        <form id="rule-selection-form" method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="ruleset_id" id="ruleset_id" value="">
            <div id="rules" class="space-y-2">
                {% for rule in rules %}
                <div class="flex items-center group/rule">
                    <input type="checkbox" id="rule-{{ rule.id }}" name="rules" value="{{ rule.id }}" class="hidden peer">
                    <label for="rule-{{ rule.id }}" class="flex-1 flex justify-between item-center py-1 px-4 bg-white rounded cursor-pointer hover:bg-gray-200 peer-checked:bg-amber-100 peer-checked:hover:bg-yellow-600/50 font-light">
                        {{ rule.name }}
                        <a href="#" class="rounded-full p-1 group-hover/rule:bg-gray-300" onclick="toggleRuleEditPanel(event, {{ rule.id }})">
                            <svg class="size-4 align-middle invisible group-hover/rule:visible" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                            </svg>
                        </a>
                    </label>
                    
                </div>
                {% endfor %}
            </div>
        </form>
    </div>

    <!-- Apply and cancel buttons (in a row, down at the bottom of the panel) -->
    <div class="absolute flex space-x-2 w-full bottom-0 p-4 bg-gray-200">
        <button class="w-1/2 bg-blue-500 text-white px-4 py-2 rounded" onclick="submitRuleSelectionForm()">Apply</button>
        <button class="w-1/2 bg-gray-500 text-white px-4 py-2 rounded" onclick="toggleRuleSelectionPanel()">Cancel</button>
    </div>
</div>

<script>
    function toggleRuleSelectionPanel(rulesetId) {
        const rulesetPanel = document.getElementById('rule-selection-panel');
        rulesetPanel.classList.toggle('hidden');

        // Store the ruleset ID in the panel's data attribute and the hidden input field
        rulesetPanel.dataset.rulesetId = rulesetId;
        document.getElementById('ruleset_id').value = rulesetId;

        if (!rulesetPanel.classList.contains('hidden')) {
            selectRulesetRules(rulesetId);
        }

        // Update the form action dynamically
        const form = document.getElementById('rule-selection-form');
        form.action = `/ruleset/${rulesetId}/edit/`;
    }

    function selectRulesetRules(rulesetId) {
        // Get the ruleset by ID
        const ruleset = rulesets.find(ruleset => ruleset.id === rulesetId);
        if (!ruleset) {
            console.error(`Ruleset with ID ${rulesetId} not found.`);
            return;
        }
        const rules = ruleset.rules;
        console.log('Rules:', rules);

        // Deselect all checkboxes first
        const ruleCheckboxes = document.querySelectorAll('#rules input[type="checkbox"]');
        ruleCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        // Select the ruleset rules
        rules.forEach(rule => {
            const ruleCheckbox = document.querySelector(`#rules input[type="checkbox"][value="${rule.id}"]`);
            if (ruleCheckbox) {
                ruleCheckbox.checked = true;
            }
        });
    }

    function searchRuleByName(name) {
        const ruleCheckboxes = document.querySelectorAll('#rules div');
        if (!name) {
            ruleCheckboxes.forEach(checkbox => checkbox.classList.remove('hidden'));
            return;
        }
        ruleCheckboxes.forEach(checkbox => {
            const ruleName = checkbox.querySelector('label').textContent;
            if (ruleName.toLowerCase().includes(name.toLowerCase())) {
                checkbox.classList.remove('hidden');
            } else {
                checkbox.classList.add('hidden');
            }
        });
    }

    function submitRuleSelectionForm() {
        // Submit the form
        document.getElementById('rule-selection-form').submit();
    }
</script>
