{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}{{ ruleset.name }}{% endblock %}

{% block content %}
    <div class="container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">{{ ruleset.name }}</h1>
                <div>
                    <a href="{% url 'policy_list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded mr-2">Back to Policies</a>
                    {% if not ruleset.is_system %}
                    <button onclick="toggleRulesetEditPanel({{ ruleset.id }})" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Edit Ruleset</button>
                    {% endif %}
                </div>
            </div>

        <!-- Ruleset Information -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden mb-6">
            <div class="p-6">
                <h2 class="text-xl font-semibold mb-4">Ruleset Information</h2>
                <dl class="grid grid-cols-2 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Name</dt>
                        <dd class="mt-1 font-medium">{{ ruleset.name }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Rules Count</dt>
                        <dd class="mt-1">
                            <span class="font-medium">{{ ruleset.rules.count }}</span> rules
                            {% if not ruleset.is_system %}
                            <button onclick="toggleRuleSelectionPanel({{ ruleset.id }})" class="ml-2 text-blue-500 hover:text-blue-700 text-sm">Manage Rules</button>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="col-span-2">
                        <dt class="text-sm font-medium text-gray-500">Description</dt>
                        <dd class="mt-1">{{ ruleset.description|default:"No description provided" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Created</dt>
                        <dd class="mt-1">{{ ruleset.created_at|date:"Y-m-d H:i" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Created By</dt>
                        <dd class="mt-1">
                            {% if ruleset.is_system %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    System
                                </span>
                            {% else %}
                                {{ ruleset|creator_name }}
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Last Updated</dt>
                        <dd class="mt-1">{{ ruleset.updated_at|date:"Y-m-d H:i" }} ({{ ruleset.updated_at|timesince }} ago)</dd>
                    </div>
                </dl>
            </div>
        </div>

        <!-- Rules in this Ruleset -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden mb-6">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Rules in This Ruleset</h2>
                    {% if not ruleset.is_system %}
                    <button onclick="toggleRuleSelectionPanel({{ ruleset.id }})" class="text-blue-500 hover:text-blue-700 text-sm">
                        Manage Rules
                    </button>
                    {% endif %}
                </div>
                {% if rules %}
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-center w-20">Enabled</th>
                                <th class="py-3 px-6 text-left">Name</th>
                                <th class="py-3 px-6 text-left">Description</th>
                                <th class="py-3 px-6 text-left">Rule Query</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                            {% for rule in rules %}
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-center">
                                    {% if rule.enabled %}
                                        <svg class="w-5 h-5 text-green-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    {% else %}
                                        <svg class="w-5 h-5 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    {% endif %}
                                </td>
                                <td class="py-3 px-6 text-left">
                                    <a href="{% url 'rule_detail' rule_id=rule.id %}" class="font-medium text-gray-800 hover:text-gray-900">
                                        {{ rule.name }}
                                    </a>
                                </td>
                                <td class="py-3 px-6 text-left">
                                    {{ rule.description|truncatewords:15 }}
                                </td>
                                <td class="py-3 px-6 text-left">
                                    <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ rule.rule_query|truncatechars:50 }}</code>
                                </td>
                                <td class="py-3 px-6 text-center">
                                    <button onclick="toggleRuleEditPanel({{ rule.id }})" class="text-gray-600 hover:text-gray-800" title="Edit">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-gray-500">
                        No rules in this ruleset yet.
                        {% if not ruleset.is_system %}
                        <button onclick="toggleRuleSelectionPanel({{ ruleset.id }})" class="text-blue-600 hover:text-blue-800 underline">Add rules</button>
                        {% endif %}
                    </p>
                {% endif %}
            </div>
        </div>

        <!-- Devices Using This Ruleset -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <div class="p-6">
                <h2 class="text-xl font-semibold mb-4">Devices Using This Ruleset</h2>
                {% if devices %}
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Hostname</th>
                                <th class="py-3 px-6 text-left">OS</th>
                                <th class="py-3 px-6 text-left">Lynis Version</th>
                                <th class="py-3 px-6 text-left">Last Update</th>
                                <th class="py-3 px-6 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                            {% for device in devices %}
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left">
                                    <a href="{% url 'device_detail' device_id=device.id %}" class="text-blue-600 hover:text-blue-800">
                                        {{ device.hostname|default:device.hostid }}
                                    </a>
                                </td>
                                <td class="py-3 px-6 text-left">{{ device.os|default:"-" }}</td>
                                <td class="py-3 px-6 text-left">{{ device.lynis_version|default:"-" }}</td>
                                <td class="py-3 px-6 text-left">
                                    {% if device.last_update %}
                                        {{ device.last_update|timesince }} ago
                                    {% else %}
                                        Never
                                    {% endif %}
                                </td>
                                <td class="py-3 px-6 text-left">
                                    <a href="{% url 'device_detail' device_id=device.id %}" class="text-gray-600 hover:text-gray-800" title="View">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-gray-500">No devices are using this ruleset yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Include sidebars -->
    {% include 'policy/ruleset_edit_sidebar.html' %}
    {% include 'policy/rule_edit_sidebar.html' %}
    {% include 'policy/rule_selection_sidebar.html' %}

    <script>
        // Pass data to JavaScript
        const rulesets = [{{ ruleset_json|safe }}];
        const rules = {{ rules_json|safe }};
    </script>
    <script src="{% static 'js/policies.js' %}"></script>
    <script src="{% static 'js/rules.js' %}"></script>
{% endblock %}

