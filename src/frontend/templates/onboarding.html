{% extends 'base.html' %}
{% load static %}

{% block title %}Onboarding{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-8">
        <div>
            <p class="text-xs font-semibold tracking-wide uppercase text-gray-500 mb-1">Getting started</p>
            <h1 class="text-3xl font-bold text-gray-900">Welcome to TrikuSec</h1>
            <p class="text-gray-600 mt-2 max-w-2xl">
                You donâ€™t have any devices enrolled yet. Follow the quick install instructions below to report your first device.
            </p>
        </div>
        <a href="{% url 'device_list' %}" class="inline-flex items-center justify-center bg-gray-800 text-white font-semibold px-4 py-2 rounded shadow hover:bg-gray-900 transition">
            View Device List
        </a>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
        <section class="bg-white shadow-md rounded-lg p-6">
            <div class="flex items-start justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Quick install</h2>
                    <p class="text-gray-500 mt-1">Run a single command on your device to enroll it automatically.</p>
                </div>
                <span class="bg-blue-100 text-blue-600 uppercase text-xs font-semibold tracking-wide px-3 py-1 rounded-full">Recommended</span>
            </div>

            <!-- License Key Selection Toggle -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium text-gray-700 mb-3">License Key Selection</label>
                <div class="flex flex-col gap-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="license-option" value="default" id="license-option-default" class="mr-2" checked>
                        <span class="text-sm text-gray-700">Use default license key <span class="text-gray-500">(default)</span></span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="license-option" value="generate" id="license-option-generate" class="mr-2">
                        <span class="text-sm text-gray-700">Generate specific license key <span class="text-green-600 font-semibold">(more secure)</span></span>
                    </label>
                </div>
                <p class="mt-2 text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    Generating a specific license key creates a 1-to-1 license that only works for a single device, improving security.
                </p>
            </div>

            <div class="relative bg-gray-900 text-gray-50 rounded-lg p-4">
                <pre class="text-sm font-mono overflow-x-auto whitespace-pre-wrap" id="enroll-command">wget -qO- --no-check-certificate {{ trikusec_url }}/download/enroll.sh?licensekey={{ licensekey }} | bash</pre>
                <button id="copy-command-btn" type="button" class="copy-button absolute top-3 right-3 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold tracking-wide px-3 py-1 rounded transition">
                    Copy
                </button>
            </div>

            <p class="mt-4 text-sm text-gray-500">
                The installer downloads the latest Lynis client, registers the device using a license key, and starts sending compliance data securely.
            </p>

            <div class="mt-6 flex flex-wrap gap-3">
                <a href="{% url 'enroll_device' %}" class="inline-flex items-center bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded shadow transition">
                    Go to enroll page
                </a>
                <button type="button" onclick="onDeviceEnrolled()" class="inline-flex items-center border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded hover:bg-gray-100 transition">
                    I already enrolled a device
                </button>
            </div>
        </section>

        <section class="bg-white shadow-md rounded-lg p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-3">Manual install & docs</h3>
            <p class="text-gray-600 mb-4">
                Need more control? Follow the manual enrollment workflow and automation examples covered in our documentation.
            </p>
            <ul class="space-y-3 text-sm text-gray-600 mb-6">
                <li class="flex items-start gap-3">
                    <span class="text-blue-500 mt-0.5">
                        <i class="fas fa-terminal"></i>
                    </span>
                    Follow the steps in the documentation and run each command yourself for manual enrollment.
                </li>
                <li class="flex items-start gap-3">
                    <span class="text-blue-500 mt-0.5">
                        <i class="fas fa-shield-alt"></i>
                    </span>
                    Configure outbound access to `{{ trikusec_url }}` over TLS for report uploads.
                </li>
                <li class="flex items-start gap-3">
                    <span class="text-blue-500 mt-0.5">
                        <i class="fas fa-book"></i>
                    </span>
                    You can also explore automation examples for Ansible, etc.
                </li>
            </ul>
            <a href="https://trikusec.github.io/trikusec/installation/client-setup/" class="inline-flex items-center text-blue-600 font-semibold hover:text-blue-700 transition">
                View installation guide
                <i class="fas fa-arrow-right ml-2 text-sm"></i>
            </a>
        </section>
    </div>

    <!-- Include license edit sidebar -->
    {% include 'license/license_edit_sidebar.html' %}
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/licenses.js' %}"></script>
<script>
    const trikusecUrl = '{{ trikusec_url }}';
    let currentLicenseKey = '{{ licensekey }}';
    let enrollCommand = `wget -qO- --no-check-certificate ${trikusecUrl}/download/enroll.sh?licensekey=${currentLicenseKey} | bash`;
    
    // Get existing autogenerated license names
    const autogeneratedLicenseNames = {{ autogenerated_license_names|safe }};
    
    // Function to get the next available number for autogenerated licenses
    function getNextAutogeneratedLicenseNumber() {
        const pattern = /^Autogenerated license-key (\d+)$/;
        let maxNumber = 0;
        
        // Extract numbers from existing autogenerated license names
        autogeneratedLicenseNames.forEach(name => {
            const match = name.match(pattern);
            if (match) {
                const number = parseInt(match[1], 10);
                if (number > maxNumber) {
                    maxNumber = number;
                }
            }
        });
        
        // Return the next available number
        return maxNumber + 1;
    }

    function updateEnrollCommand(licenseKey) {
        currentLicenseKey = licenseKey;
        enrollCommand = `wget -qO- --no-check-certificate ${trikusecUrl}/download/enroll.sh?licensekey=${licenseKey} | bash`;
        const commandElement = document.getElementById('enroll-command');
        if (commandElement) {
            commandElement.textContent = enrollCommand;
        }
    }

    function setButtonState(button, text, classesToAdd, classesToRemove) {
        button.textContent = text;
        classesToRemove.forEach(cls => button.classList.remove(cls));
        classesToAdd.forEach(cls => button.classList.add(cls));
    }

    function copyToClipboard(button) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(enrollCommand).then(() => {
                setButtonState(button, 'Copied', ['bg-gray-600', 'hover:bg-gray-700'], ['bg-blue-500', 'hover:bg-blue-600']);
                setTimeout(() => {
                    setButtonState(button, 'Copy', ['bg-blue-500', 'hover:bg-blue-600'], ['bg-gray-600', 'hover:bg-gray-700']);
                }, 2000);
            });
            return;
        }

        const textarea = document.createElement('textarea');
        textarea.value = enrollCommand;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
    }

    function onDeviceEnrolled() {
        window.location.href = '{% url "device_list" %}';
    }

    // Override form submission for onboarding page
    // Use setTimeout to ensure licenses.js has loaded and set up its listeners
    setTimeout(function() {
        const form = document.getElementById('license-edit-form');
        if (form) {
            // Store original submitLicenseForm if it exists
            const originalSubmitLicenseForm = window.submitLicenseForm;
            
            // Override submitLicenseForm for onboarding
            window.submitLicenseForm = function() {
                const form = document.getElementById('license-edit-form');
                // Ensure form action is correct
                if (form && !form.action.includes('/edit/')) {
                    form.action = '/licenses/create/';
                }
                const formData = new FormData(form);
                
                // Show loading state
                const submitButton = form.querySelector('button[type="submit"]');
                if (!submitButton) return;
                
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Saving...';
                submitButton.disabled = true;

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update the command with the newly created license key
                        if (data.licensekey) {
                            updateEnrollCommand(data.licensekey);
                        }
                        
                        // Close the panel without resetting the radio button
                        // (since save was successful, keep "Generate specific license key" selected)
                        const panel = document.getElementById('license-edit-panel');
                        if (panel) {
                            panel.classList.add('hidden');
                        }
                    } else {
                        // Show errors
                        if (typeof showFormErrors !== 'undefined') {
                            showFormErrors(data.errors);
                        } else {
                            console.error('Form errors:', data.errors);
                        }
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (typeof showFormErrors !== 'undefined') {
                        showFormErrors(['An error occurred while saving the license.']);
                    } else {
                        alert('An error occurred while saving the license.');
                    }
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                });
            };
        }
    }, 100);

    // Override toggleLicenseEditPanel to handle Cancel button for onboarding
    setTimeout(function() {
        if (typeof toggleLicenseEditPanel !== 'undefined') {
            const originalToggleLicenseEditPanel = window.toggleLicenseEditPanel;
            window.toggleLicenseEditPanel = function(licenseId) {
                const panel = document.getElementById('license-edit-panel');
                const wasHidden = panel.classList.contains('hidden');
                
                // Call original function
                originalToggleLicenseEditPanel(licenseId);
                
                // Only reset to default license if we're closing the panel (it was visible)
                // AND we're not creating a new license (licenseId is null means creating)
                // This handles the Cancel button case
                if (!wasHidden && licenseId === null) {
                    // Check if we're on the onboarding page and if "Generate" option is selected
                    const generateOption = document.getElementById('license-option-generate');
                    if (generateOption && generateOption.checked) {
                        // User clicked Cancel, so reset to default license key option
                        const defaultOption = document.getElementById('license-option-default');
                        if (defaultOption) {
                            defaultOption.checked = true;
                            updateEnrollCommand('{{ licensekey }}');
                        }
                    }
                }
            };
        }
    }, 100);

    function handleLicenseOptionChange() {
        const selectedOption = document.querySelector('input[name="license-option"]:checked').value;
        
        if (selectedOption === 'generate') {
            // Calculate the next available number for autogenerated licenses
            const nextNumber = getNextAutogeneratedLicenseNumber();
            const licenseName = `Autogenerated license-key ${nextNumber}`;
            
            // Open the license edit panel in create mode
            toggleLicenseEditPanel(null);
            
            // Ensure form action is correct (fix for cached JS)
            const form = document.getElementById('license-edit-form');
            if (form) {
                form.action = '/licenses/create/';
            }
            
            // Pre-fill the form with autogenerated values
            document.getElementById('license_name').value = licenseName;
            document.getElementById('license_max_devices').value = '1';
            document.getElementById('license_is_active').checked = true;
            document.getElementById('license_is_active_message').textContent = 'ACTIVE';
            document.getElementById('license_expires_at').value = '';
            
        } else {
            // Use default license key
            updateEnrollCommand('{{ licensekey }}');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const copyButton = document.getElementById('copy-command-btn');
        if (copyButton) {
            copyButton.addEventListener('click', () => copyToClipboard(copyButton));
        }

        // Add event listeners for license option radio buttons
        const licenseOptions = document.querySelectorAll('input[name="license-option"]');
        licenseOptions.forEach(option => {
            option.addEventListener('change', handleLicenseOptionChange);
        });
    });
</script>
{% endblock %}