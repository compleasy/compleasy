#!/usr/bin/env bash

TRIKUSEC_URL={{ trikusec_url }}
TRIKUSEC_CERT_URL=${TRIKUSEC_URL}/download/server.crt
TRIKUSEC_CERT_TMP=/tmp/trikusec.crt
TRIKUSEC_PRF_URL=${TRIKUSEC_URL}/download/lynis_custom_profile
TRIKUSEC_LICENSEKEY={{ licensekey }}

if [ ! -f /etc/debian_version ]; then
    echo "This script is only compatible with Debian-based systems."
    exit 1
fi

# If user is not root, use sudo if available
if [ $(id -u) -ne 0 ]; then
    if [ -x "$(command -v sudo)" ]; then
        SUDO=sudo
    else
        echo "Please run this script as root or install sudo."
        exit 1
    fi
fi

# Check if the server is reachable and has a valid certificate
curl -s "${TRIKUSEC_URL}" -o /dev/null
if [ $? -ne 0 ]; then
    echo "Server certificate is self-signed. Adding it to the trusted certificates."
    # Check if openssl and ca-certificates are installed
    if [ ! -x "$(command -v openssl)" ] || [ ! -x "$(command -v update-ca-certificates)" ]; then
        echo "openssl or ca-certificates are not installed. Installing them..."
        ${SUDO} apt-get update && ${SUDO} apt-get install -y openssl ca-certificates
    fi
    # Derive host:port from TRIKUSEC_URL, defaulting to 443 when no port provided
    HOSTPORTPATH=${TRIKUSEC_URL#https://}
    HOSTPORT=${HOSTPORTPATH%%/*}
    case "$HOSTPORT" in
        *:*) OPENSSL_CONNECT="$HOSTPORT" ;;
        *) OPENSSL_CONNECT="$HOSTPORT:443" ;;
    esac
    openssl s_client -showcerts -connect "${OPENSSL_CONNECT}" </dev/null 2>/dev/null | sed -n -e '/BEGIN\ CERTIFICATE/,/END\ CERTIFICATE/ p' > ${TRIKUSEC_CERT_TMP}
    ${SUDO} cp ${TRIKUSEC_CERT_TMP} /usr/local/share/ca-certificates/trikusec.crt
    ${SUDO} update-ca-certificates
    rm -f ${TRIKUSEC_CERT_TMP}
else
    echo "Server certificate is valid."
fi

# Update and install necessary packages
${SUDO} apt-get update
${SUDO} apt-get install -y curl lynis rkhunter auditd

# Get installed Lynis version
LYNIS_VERSION=$(lynis --version)

# Configure Lynis agent
${SUDO} curl -s "${TRIKUSEC_PRF_URL}?licensekey=${TRIKUSEC_LICENSEKEY}&lynis_version=${LYNIS_VERSION}" -o /etc/lynis/custom.prf

# Run Lynis
${SUDO} lynis audit system --upload --quick --cronjob --auditor "TrikuSec agent"

# Enable systemd timer for daily audit
${SUDO} systemctl enable lynis.timer