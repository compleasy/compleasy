{% extends 'base.html' %}
{% load custom_filters %}
{% load humanize %}

{% block title %}Device {{ report.hostname }}{% endblock %}
{% block content %}
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6"><a href="{% url 'index' %}">Compleasy</a></h1>
        
        <!-- Device details Screen -->
        <div id="serverDetails">
            <!--<h2 class="text-2xl font-bold mb-6">{{ report.hostname }}</h2>-->

            <!-- Back button (arrow) -->
            <a href="{% url 'device_list' %}" class="p-2 text-gray-600 hover:text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </a>

            <!-- Overview Section -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden p-6 mb-4">
                <h3 class="text-xl font-semibold mb-4">Overview</h3>
                <div class="grid grid-cols-2">

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Device name</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2">{{ report.hostname }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Compliance</div>
                        <div class="text-left w-80 text-gray-900 font-medium">:
                            {% if device.compliant %}
                            <span class="ml-2 bg-green-200 text-green-600 py-1 px-3 rounded-full text-xs">Compliant</span>
                            {% else %}
                            <span class="ml-2 bg-red-200 text-red-600 py-1 px-3 rounded-full text-xs">Non-compliant</span>
                            {% endif %}
                        </div>
                    </div> 

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">IP Address</div>
                        <div class="text-left w-96 text-gray-900">:
                            <span class="ml-2 font-mono">{{ report.primary_ipv4_addresses|default_if_none:"-"|format_csv_line:" / " }}</span></div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Enrolled by</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 font-light">{{ device.licensekey.created_by.email }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">MAC Address</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 font-mono">
                                {{ report.network_mac_address.0 }}
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Enrollment Date</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 italic">{{ device.created_at|date:'Y-m-d H:s' }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Hostid</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 font-mono">{{ report.hostid|shorten_string:10 }}</span></div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Hostid2</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 font-mono">
                                {{ report.hostid2|shorten_string:10 }}
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Operating System</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2">{{ report.os }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Kernel Version</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 font-mono">{{ report.os_kernel_version_full }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Distribution</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 inline-flex">{{ report.os_fullname }} {{ report.os_fullname|distro_icon }}</span>
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Uptime</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 italic">{{ report.uptime_in_days }} days</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Last check-in time</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 italic">{{ device.last_update|date:'Y-m-d H:s' }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Compleasy Lynis plugin</div>
                        <div class="text-left w-80 text-gray-900 inline-flex">:
                                <span class="ml-2">{{ report.compleasy_custom_tests|boolean_icon }}</span>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Audit Section -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden p-6 mb-4">
                <h3 class="text-xl font-semibold mb-4">Audit</h3>
                <div class="grid grid-cols-2">

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Lynis version</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2">{{ device.lynis_version }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Audit frequency</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 italic">{{ report.lynis_timer_period|default_if_none:"-" }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Last report</div>
                        <div class="text-left w-80 text-gray-900 inline-flex">:
                            <span class="ml-2 italic">{{ report.report_datetime_end|naturaltime }}</span>
                            <a href="{% url 'device_report' device_id=device.id %}"><span title="View raw report" class="cursor-pointer" onclick="">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 ml-2 hover:fill-gray-200">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v16.5c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Zm3.75 11.625a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                                  </svg>
                                  
                            </span></a>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Next scheduled audit</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 italic">{{ report.lynis_timer_next_trigger|default_if_none:"-"|naturaltime }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Hardening index</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 italic">{{ report.hardening_index }}/100</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Tests performed</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 italic">{{ report.lynis_tests_done }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Failed logins</div>
                        <div class="text-left w-80 text-gray-900 inline-flex">:
                            <span class="ml-2">{{ report.auth_failed_logins_logged|boolean_icon }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Firewall</div>
                        <div class="text-left w-80 text-gray-900 inline-flex">:
                            <span class="ml-2">{{ report.firewall_active|boolean_icon }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Antivirus</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2">{{ report.clamav_version|default_if_none:"-" }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 w-96 space-y-2">
                        <div class="text-left text-gray-600 mt-2">Last AV update</div>
                        <div class="text-left w-80 text-gray-900">:
                            <span class="ml-2 italic">{{ report.clamav_last_update|default_if_none:"-" }}</span>
                        </div>
                    </div>
                
                </div>
            </div>

            <!-- Compliance Section -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden p-6 mb-4">
                <h3 class="text-xl font-semibold mb-4">Compliance</h3>
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-2">Policy Rulesets</h4>
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="w-4 py-3 px-2 text-left"></th>
                                <th class="w-64 py-3 px-6 text-left">Rule</th>
                                <th class="py-3 px-6 text-left">Description</th>
                                <th class="min-w-10 max-w-12 py-3 px-6 text-center">Policy status</th>
                                <!-- Action buttons -->
                                <th class="py-3 px-6 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">

                            {% for ruleset in evaluated_rulesets %}
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 justify-center">
                                    <span class="cursor-pointer" onclick="toggleRules(this)">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 hover:text-gray-900">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                        </svg>
                                    </span>
                                </td>
                                <td class="py-3 px-6 text-left"><span>{{ ruleset.name }}</span></td>
                                <td class="w-1/2 py-3 px-6 text-left"><span">{{ ruleset.description }}</span></td>
                                <td class="py-3 px-6 justify-center">
                                    {% if ruleset.compliant %}
                                    <!-- Green check -->
                                     <span class="fill-current text-green-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 mx-auto">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z" />
                                        </svg>
                                          
                                             
                                      </span>                                 
                                        
                                    {% else %}
                                    <span class="fill-current text-red-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 mx-auto">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.25-8.25-3.286Zm0 13.036h.008v.008H12v-.008Z" />
                                          </svg>                                               
                                      </span>   
                                    {% endif %}
                                </td>
                                <!-- Buttons to Unassign policy ruleset to the device, or Edit the ruleset -->
                                <td class="py-3 px-6 text-center">
                                    <div class="flex justify-center space-x-2">
                                        <a href="#" class="text-gray-600 hover:text-red-800">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.181 8.68a4.503 4.503 0 0 1 1.903 6.405m-9.768-2.782L3.56 14.06a4.5 4.5 0 0 0 6.364 6.365l3.129-3.129m5.614-5.615 1.757-1.757a4.5 4.5 0 0 0-6.364-6.365l-4.5 4.5c-.258.26-.479.541-.661.84m1.903 6.405a4.495 4.495 0 0 1-1.242-.88 4.483 4.483 0 0 1-1.062-1.683m6.587 2.345 5.907 5.907m-5.907-5.907L8.898 8.898M2.991 2.99 8.898 8.9" />
                                            </svg>
                                            
                                        </a>
                                        <a href="#" class="text-gray-600 hover:text-gray-900">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                            </svg>
                                            
                                        </a>
                                    </div> 
                            </tr>

                            <!-- Rules hidden -->
                            {% for rule in ruleset.rules %}
                            <tr class="hidden-rule hidden border-b border-gray-200 hover:bg-gray-100">
                                <td class="w-4 py-3 px-6"></td>
                                <td class="py-3 px-6 text-left">
                                    <div class="flex items-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14" />
                                        </svg>        
                                    <span>{{ rule.name }}</span>
                                    </div>
                                </td>
                                <td class="py-3 px-6 text-left">{{ rule.description }}</td>
                                <td class="py-3 px-6 justify-center">
                                    {% if rule.compliant %}
                                    <span class="fill-current text-green-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 mx-auto">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                                          </svg>                                               
                                      </span>  
                                    {% else %}
                                    <span class="fill-current text-red-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 mx-auto">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                          </svg>                                                                                         
                                      </span>
                                    {% endif %}
                                </td>
                                <td class="py-3 px-6 text-center">
                                    <div class="flex justify-center space-x-2">
                                        <!--empty div to align edit buttons. I know, i know...-->
                                        <div class="w-6"></div>
                                        <a href="#" class="text-gray-600 hover:text-gray-900">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                            </svg>
                                            
                                        </a>
                                    </div>
                                </td>
                            {% endfor %}

                            {% endfor %}
                    </table>
                </div>
                <!-- Button: create a ruleset -->
                <div class="text-right">
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded inline-flex items-center">New ruleset</button>
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded inline-flex items-center">New rule</button>
                </div>
                

            </div>

            <!-- Security Section -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden p-6">
                <h3 class="text-xl font-semibold mb-4">Security feedback</h3>
                
                <!-- Warnings Subsection -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-2">Warnings</h4>
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="w-36 py-3 px-6 text-left">Test-ID</th>
                                <th class="py-3 px-6 text-left">Description</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">

                            {% for warning in report.warning %}
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left">{{ warning.0 }}</td>
                                <td class="py-3 px-6 text-left">
                                    <span {%  if warning|length > 2 %} class="expand-description" onclick="toggleDetails(this)" {% endif %}>{{ warning.1 }}
                                    {% if warning|length > 2 %}
                                    <i class="fas fa-info-circle info-icon"></i>
                                    {% endif %}
                                    </span>
                                    <div class="hidden-details hidden mt-2">
                                        {% for detail in warning|slice:'2:' %}
                                        <p class="italic">{{ detail }}</p>
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}

                        </tbody>
                    </table>
                </div>
                
                <!-- Suggestions Subsection -->
                <div>
                    <h4 class="text-lg font-medium mb-2">Suggestions</h4>
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="w-36 py-3 px-6 text-left">Test-ID</th>
                                <th class="py-3 px-6 text-left">Description</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">

                            {% for suggestion in report.suggestion %}
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left">{{ suggestion.0 }}</td>
                                <td class="py-3 px-6 text-left">
                                    <span {%  if suggestion|length > 2 %}class="expand-description" onclick="toggleDetails(this)"{% endif %}>{{ suggestion.1 }}
                                    {% if suggestion|length > 2 %}
                                    <i class="fas fa-info-circle info-icon"></i>
                                    {% endif %}
                                    </span>
                                    <div class="hidden-details hidden mt-2">
                                        {% for detail in suggestion|slice:'2:' %}
                                        <p class="italic">{{ detail }}</p>
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleDetails(element) {
            var details = element.closest('td').querySelector('.hidden-details');
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        }
        function toggleRules(element) {
            var rules = document.querySelectorAll('.hidden-rule');
            rules.forEach(function(rule) {
                rule.classList.toggle('hidden');
            });
        }
    </script>
<!-- </body>
</html> -->
{% endblock %}
